#!/usr/bin/env ruby

require "rubygems"
require "bundler/setup"

require 'optparse'
require "simple_metrics"

SimpleMetrics.logger = Logger.new("/dev/null")
SimpleMetrics::DataPointRepository.truncate_collections
SimpleMetrics::DataPointRepository.ensure_collections_exist

bucket = SimpleMetrics::Bucket.first

name = "test.page.visits.1"
now = Time.now.to_i
minute = 60
hour   = minute * 60

def create_dps(name)
  previous_value = rand(300)
  (1..5).inject([]) do |result, index|
    value = previous_value+rand(20)
    result << SimpleMetrics::DataPoint.create_counter(:name => name, :value => value)
    result
  end
end

counter = 1
current = now - 1 * hour
while (current < now)
  dps = create_dps(name)
  puts "flush data for #{Time.at(current)}, #{counter}"
  SimpleMetrics::Bucket.flush_data_points(dps, current)
  current += 10
  counter += 1
end
